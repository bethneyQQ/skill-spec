{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "skill-spec/1.2",
  "title": "Skill-Spec Schema v1.2",
  "description": "JSON Schema for Skill-Spec specification files. Section Taxonomy: 8 Core (required) + 1 Coverage (required) + Optional sections. v1.2 adds agentskills.io compatibility (https://agentskills.io/specification)",
  "type": "object",
  "required": [
    "spec_version",
    "skill",
    "inputs",
    "preconditions",
    "non_goals",
    "decision_rules",
    "steps",
    "output_contract",
    "failure_modes",
    "edge_cases"
  ],
  "additionalProperties": false,
  "properties": {
    "spec_version": {
      "type": "string",
      "enum": ["skill-spec/1.0", "skill-spec/1.1", "skill-spec/1.2"],
      "description": "Schema version identifier"
    },
    "_meta": {
      "$ref": "#/definitions/MetaConfig"
    },
    "skill": {
      "$ref": "#/definitions/SkillMetadata"
    },
    "triggers": {
      "$ref": "#/definitions/Triggers"
    },
    "inputs": {
      "type": "array",
      "description": "Input contract definitions",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/InputSpec"
      }
    },
    "preconditions": {
      "type": "array",
      "description": "Prerequisites that must be true before skill execution",
      "minItems": 1,
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "non_goals": {
      "type": "array",
      "description": "Explicit statements of what this skill does NOT do",
      "minItems": 1,
      "items": {
        "type": "string",
        "minLength": 1
      }
    },
    "boundaries": {
      "$ref": "#/definitions/Boundaries"
    },
    "decision_rules": {
      "$ref": "#/definitions/DecisionRules"
    },
    "steps": {
      "type": "array",
      "description": "Ordered execution steps",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/ExecutionStep"
      }
    },
    "behavioral_flow": {
      "$ref": "#/definitions/BehavioralFlow"
    },
    "output_contract": {
      "$ref": "#/definitions/OutputContract"
    },
    "failure_modes": {
      "type": "array",
      "description": "Designed failure scenarios",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/FailureMode"
      }
    },
    "edge_cases": {
      "type": "array",
      "description": "Boundary conditions and edge cases (Coverage section - required)",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/EdgeCase"
      }
    },
    "anti_patterns": {
      "$ref": "#/definitions/AntiPatterns"
    },
    "tools": {
      "type": "array",
      "description": "v1.2: Custom tool definitions for MCP or external integrations",
      "items": {
        "$ref": "#/definitions/ToolDefinition"
      }
    },
    "context": {
      "$ref": "#/definitions/ContextInfo"
    },
    "examples": {
      "type": "array",
      "description": "Usage examples (recommended for Anthropic format)",
      "items": {
        "$ref": "#/definitions/Example"
      }
    }
  },
  "definitions": {
    "MetaConfig": {
      "type": "object",
      "description": "Meta configuration for the spec",
      "properties": {
        "content_language": {
          "type": "string",
          "enum": ["en", "zh", "auto"],
          "default": "en",
          "description": "Primary content language"
        },
        "mixed_language_strategy": {
          "type": "string",
          "enum": ["union", "segment_detect", "primary", "zh-primary"],
          "default": "union",
          "description": "Strategy for mixed language validation"
        },
        "format": {
          "type": "string",
          "enum": ["full", "minimal"],
          "default": "full",
          "description": "v1.1: Spec format - full (all sections) or minimal (required sections only)"
        },
        "token_budget": {
          "type": "integer",
          "minimum": 50,
          "maximum": 2000,
          "default": 500,
          "description": "v1.1: Target word count for generated SKILL.md (frequent skills: <200, standard: <500)"
        },
        "agentskills_compat": {
          "type": "boolean",
          "default": false,
          "description": "v1.2: Enable agentskills.io compatibility mode. When true, validates against agentskills.io spec requirements"
        },
        "progressive_disclosure": {
          "type": "object",
          "description": "v1.2: Token budget configuration for progressive disclosure (agentskills.io pattern)",
          "properties": {
            "metadata_tokens": {
              "type": "integer",
              "minimum": 50,
              "maximum": 200,
              "default": 100,
              "description": "Target tokens for metadata section (~100 tokens recommended)"
            },
            "instructions_tokens": {
              "type": "integer",
              "minimum": 500,
              "maximum": 5000,
              "default": 2000,
              "description": "Target tokens for instructions section (<5000 tokens recommended)"
            },
            "max_lines": {
              "type": "integer",
              "minimum": 100,
              "maximum": 1000,
              "default": 500,
              "description": "Maximum lines for main SKILL.md file (<500 lines recommended)"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "SkillMetadata": {
      "type": "object",
      "description": "Core skill metadata (Section 1). v1.2 adds agentskills.io compatibility fields",
      "required": ["name", "version", "purpose", "owner"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9]*(-[a-z0-9]+)*$",
          "minLength": 1,
          "maxLength": 64,
          "description": "Kebab-case skill name (1-64 chars, agentskills.io compliant)",
          "examples": ["extract-api-contract", "code-review-assistant"]
        },
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Semantic version (MAJOR.MINOR.PATCH)"
        },
        "purpose": {
          "type": "string",
          "minLength": 10,
          "maxLength": 1024,
          "description": "Single sentence purpose statement. Maps to 'description' in agentskills.io format (1-1024 chars)"
        },
        "owner": {
          "type": "string",
          "minLength": 1,
          "description": "Team or individual responsible"
        },
        "category": {
          "type": "string",
          "enum": ["documentation", "analysis", "generation", "transformation", "validation", "orchestration", "other"],
          "description": "v1.1: Skill category for classification"
        },
        "complexity": {
          "type": "string",
          "enum": ["low", "standard", "advanced"],
          "default": "standard",
          "description": "v1.1: Complexity level"
        },
        "tools_required": {
          "type": "array",
          "description": "v1.1: Tools/capabilities this skill needs (e.g., file_read, file_write, search, web_access, code_execution, api_call)",
          "items": {
            "type": "string"
          },
          "examples": [["file_read", "file_write", "search"], ["web_access", "api_call"]]
        },
        "personas": {
          "type": "array",
          "description": "v1.1: Roles that benefit from this skill",
          "items": {
            "type": "string"
          },
          "examples": [["developer", "architect"], ["technical-writer", "qa-specialist"]]
        },
        "license": {
          "type": "string",
          "description": "v1.2 (agentskills.io): SPDX license identifier or reference to bundled LICENSE file",
          "examples": ["Apache-2.0", "MIT", "LICENSE"]
        },
        "compatibility": {
          "type": "string",
          "maxLength": 500,
          "description": "v1.2 (agentskills.io): Environment requirements, system packages, or network needs (max 500 chars)",
          "examples": ["Requires Python 3.9+", "Needs network access for API calls"]
        },
        "allowed_tools": {
          "type": "array",
          "description": "v1.2 (agentskills.io): Pre-approved tools for execution (experimental). Space-delimited in SKILL.md",
          "items": {
            "type": "string"
          },
          "examples": [["Read", "Write", "Bash"], ["WebFetch", "Grep"]]
        },
        "metadata": {
          "type": "object",
          "description": "v1.2 (agentskills.io): Custom key-value properties beyond the spec",
          "additionalProperties": true
        }
      }
    },
    "Triggers": {
      "type": "object",
      "description": "v1.1: When to activate this skill (from Superpowers 'Use when...' pattern)",
      "additionalProperties": false,
      "properties": {
        "use_when": {
          "type": "array",
          "description": "Conditions that should trigger this skill",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "examples": [["User requests README generation", "Codebase lacks documentation", "API changes require doc updates"]]
        },
        "do_not_use_when": {
          "type": "array",
          "description": "Conditions when this skill should NOT be used",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "examples": [["Translating existing documentation", "Creating marketing content"]]
        }
      }
    },
    "Boundaries": {
      "type": "object",
      "description": "v1.1: Clear will/will_not declarations (from SuperClaude)",
      "additionalProperties": false,
      "properties": {
        "will": {
          "type": "array",
          "description": "Explicit capabilities this skill provides",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "examples": [["Extract documentation from code comments", "Generate Markdown formatted output"]]
        },
        "will_not": {
          "type": "array",
          "description": "Explicit limitations and exclusions",
          "items": {
            "type": "string",
            "minLength": 1
          },
          "examples": [["Translate existing documentation", "Infer undocumented behavior"]]
        }
      }
    },
    "BehavioralFlow": {
      "type": "array",
      "description": "v1.1: High-level behavioral phases (from SuperClaude, alternative/supplement to steps)",
      "items": {
        "type": "object",
        "required": ["phase", "description"],
        "additionalProperties": false,
        "properties": {
          "phase": {
            "type": "string",
            "description": "Phase name (e.g., analyze, generate, validate)",
            "examples": ["analyze", "generate", "validate", "transform"]
          },
          "description": {
            "type": "string",
            "description": "What happens in this phase"
          },
          "key_actions": {
            "type": "array",
            "description": "Key actions performed in this phase",
            "items": {
              "type": "string"
            }
          }
        }
      }
    },
    "AntiPatterns": {
      "type": "object",
      "description": "v1.1: Common mistakes and rationalizations (from Superpowers)",
      "additionalProperties": false,
      "properties": {
        "mistakes": {
          "type": "array",
          "description": "Common mistakes AI might make",
          "items": {
            "type": "object",
            "required": ["pattern", "why_bad", "correct"],
            "additionalProperties": false,
            "properties": {
              "pattern": {
                "type": "string",
                "description": "Description of the mistake pattern"
              },
              "why_bad": {
                "type": "string",
                "description": "Why this pattern is problematic"
              },
              "correct": {
                "type": "string",
                "description": "What to do instead"
              }
            }
          }
        },
        "rationalizations": {
          "type": "array",
          "description": "Excuses AI might use to skip rules",
          "items": {
            "type": "object",
            "required": ["excuse", "reality"],
            "additionalProperties": false,
            "properties": {
              "excuse": {
                "type": "string",
                "description": "The rationalization/excuse"
              },
              "reality": {
                "type": "string",
                "description": "Why the excuse is wrong"
              }
            }
          }
        },
        "red_flags": {
          "type": "array",
          "description": "Warning signs that the skill is being misused",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "InputSpec": {
      "type": "object",
      "description": "Input specification with domain support (Section 2)",
      "required": ["name", "type", "required"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Input parameter name (snake_case)"
        },
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean", "object", "array"],
          "description": "Data type"
        },
        "required": {
          "type": "boolean",
          "description": "Whether this input is required"
        },
        "constraints": {
          "type": "array",
          "description": "Validation constraints",
          "items": {
            "oneOf": [
              {
                "type": "string",
                "enum": ["not_empty", "not_null", "positive", "non_negative"]
              },
              {
                "type": "object",
                "additionalProperties": false,
                "properties": {
                  "max_length": {
                    "oneOf": [
                      {"type": "integer", "minimum": 1},
                      {
                        "type": "object",
                        "required": ["value"],
                        "properties": {
                          "value": {"type": "integer", "minimum": 1},
                          "mode": {"type": "string", "enum": ["chars", "tokens", "info_units"]},
                          "override_reason": {"type": "string"}
                        }
                      }
                    ]
                  },
                  "min_length": {"type": "integer", "minimum": 0},
                  "max_value": {"type": "number"},
                  "min_value": {"type": "number"},
                  "pattern": {"type": "string"},
                  "enum": {
                    "type": "array",
                    "items": {"type": "string"}
                  }
                }
              }
            ]
          }
        },
        "domain": {
          "$ref": "#/definitions/InputDomain"
        },
        "description": {
          "type": "string",
          "description": "Semantic definition of this input"
        },
        "default": {
          "description": "Default value if not provided"
        },
        "tags": {
          "type": "array",
          "description": "Data classification tags",
          "items": {"type": "string"}
        }
      }
    },
    "InputDomain": {
      "type": "object",
      "description": "Domain specification for coverage analysis",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["enum", "range", "pattern_set", "boolean", "any"],
          "description": "Domain type for coverage calculation"
        },
        "values": {
          "type": "array",
          "description": "Enum values (for type: enum)",
          "items": {}
        },
        "min": {
          "type": "number",
          "description": "Minimum value (for type: range)"
        },
        "max": {
          "type": "number",
          "description": "Maximum value (for type: range)"
        },
        "patterns": {
          "type": "array",
          "description": "Pattern set (for type: pattern_set)",
          "items": {"type": "string"}
        }
      }
    },
    "DecisionRules": {
      "description": "Decision rules with configuration (Section 5). Supports three formats: 1) _config + rules (canonical), 2) _config + rule_name (key-value pairs), 3) direct list of rules (legacy)",
      "oneOf": [
        {
          "type": "object",
          "description": "Object format: canonical (_config + rules) or key-value pairs",
          "properties": {
            "_config": {
              "$ref": "#/definitions/DecisionRulesConfig"
            },
            "rules": {
              "type": "array",
              "description": "List of decision rules (nested format)",
              "items": {
                "$ref": "#/definitions/DecisionRule"
              }
            }
          },
          "additionalProperties": {
            "$ref": "#/definitions/DecisionRule"
          },
          "patternProperties": {
            "^(?!_config$|rules$).*$": {
              "$ref": "#/definitions/DecisionRule"
            }
          }
        },
        {
          "type": "array",
          "description": "Legacy list format: direct array of rules",
          "items": {
            "$ref": "#/definitions/DecisionRule"
          }
        }
      ]
    },
    "DecisionRulesConfig": {
      "type": "object",
      "description": "Configuration for decision rule matching",
      "properties": {
        "match_strategy": {
          "type": "string",
          "enum": ["first_match", "priority", "all_match"],
          "default": "first_match",
          "description": "How to select matching rules"
        },
        "conflict_resolution": {
          "type": "string",
          "enum": ["error", "warn", "first_wins"],
          "default": "error",
          "description": "How to handle multiple matches"
        }
      },
      "additionalProperties": false
    },
    "DecisionRule": {
      "type": "object",
      "description": "Individual decision rule. When used as key-value pairs in decision_rules, the key serves as the id.",
      "required": ["when", "then"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Unique rule identifier. Optional when rule is defined as key-value pair (key becomes id)"
        },
        "priority": {
          "type": "integer",
          "minimum": 0,
          "default": 0,
          "description": "Rule priority (higher = checked first)"
        },
        "is_default": {
          "type": "boolean",
          "default": false,
          "description": "Whether this is the default/fallback rule"
        },
        "when": {
          "oneOf": [
            {"type": "string"},
            {"type": "boolean"},
            {"type": "object"}
          ],
          "description": "Condition expression (simple syntax or JSON Logic)"
        },
        "then": {
          "type": "object",
          "description": "Action to take when condition matches",
          "properties": {
            "status": {
              "type": "string",
              "enum": ["success", "error", "skip", "delegate"]
            },
            "code": {
              "type": "string",
              "description": "Error or result code"
            },
            "action": {
              "type": "string",
              "description": "Action to execute"
            },
            "path": {
              "type": "string",
              "description": "Execution path to follow"
            },
            "log": {
              "type": "string",
              "enum": ["debug", "info", "warning", "error"]
            }
          },
          "additionalProperties": true
        }
      }
    },
    "ToolParam": {
      "type": "object",
      "description": "v1.2: Tool parameter definition",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Parameter name"
        },
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean", "object", "array"],
          "default": "string",
          "description": "Parameter type"
        },
        "required": {
          "type": "boolean",
          "default": false,
          "description": "Whether this parameter is required"
        },
        "description": {
          "type": "string",
          "description": "Parameter description"
        },
        "default": {
          "description": "Default value if not provided"
        }
      }
    },
    "ToolDefinition": {
      "type": "object",
      "description": "v1.2: Tool definition for skill execution. Standard tools (Read, Write, Bash, etc.) are pre-defined. Custom tools can be defined for MCP or external integrations.",
      "required": ["name"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Tool name (e.g., 'Read', 'Write', 'Bash', or custom MCP tool)"
        },
        "description": {
          "type": "string",
          "description": "What this tool does"
        },
        "params": {
          "type": "array",
          "description": "Tool parameters",
          "items": {
            "$ref": "#/definitions/ToolParam"
          }
        },
        "returns": {
          "type": "string",
          "description": "Description of what the tool returns"
        },
        "requires_approval": {
          "type": "boolean",
          "default": false,
          "description": "Whether this tool requires user approval before execution"
        },
        "sandbox_safe": {
          "type": "boolean",
          "default": true,
          "description": "Whether this tool is safe to run in sandbox mode"
        }
      }
    },
    "ToolBinding": {
      "type": "object",
      "description": "v1.2: Binds a tool to an execution step",
      "required": ["tool"],
      "additionalProperties": false,
      "properties": {
        "tool": {
          "type": "string",
          "description": "Tool name to invoke (e.g., 'Read', 'Bash')"
        },
        "params": {
          "type": "object",
          "description": "Parameter values, can use template syntax like '{{ input.path }}'",
          "additionalProperties": true
        },
        "timeout": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 600000,
          "description": "Timeout in milliseconds (1000-600000)"
        },
        "on_error": {
          "type": "string",
          "description": "Error handling: 'fail', 'skip', 'retry', or failure_mode code"
        }
      }
    },
    "ExecutionStep": {
      "type": "object",
      "description": "Execution step definition (Section 6). Supports both abstract actions and concrete tool bindings.",
      "required": ["id", "action"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Unique step identifier"
        },
        "action": {
          "type": "string",
          "minLength": 1,
          "description": "Action to perform (human-readable description)"
        },
        "output": {
          "type": "string",
          "description": "Output variable name"
        },
        "based_on": {
          "type": "array",
          "description": "Input dependencies from previous steps",
          "items": {"type": "string"}
        },
        "condition": {
          "type": "string",
          "description": "Optional condition for step execution"
        },
        "tool_binding": {
          "$ref": "#/definitions/ToolBinding",
          "description": "v1.2: Concrete tool to execute for this step"
        }
      }
    },
    "OutputContract": {
      "type": "object",
      "description": "Output contract specification (Section 7)",
      "required": ["format", "schema"],
      "additionalProperties": false,
      "properties": {
        "format": {
          "type": "string",
          "enum": ["json", "text", "markdown", "yaml", "binary"],
          "description": "Output format"
        },
        "schema": {
          "type": "object",
          "description": "JSON Schema for output validation"
        }
      }
    },
    "FailureMode": {
      "type": "object",
      "description": "Failure mode definition (Section 8)",
      "required": ["code", "retryable"],
      "additionalProperties": false,
      "properties": {
        "code": {
          "type": "string",
          "pattern": "^[A-Z][A-Z0-9_]*$",
          "description": "Error code (UPPER_SNAKE_CASE)"
        },
        "retryable": {
          "type": "boolean",
          "description": "Whether this failure can be retried"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description"
        },
        "recovery_hint": {
          "type": "string",
          "description": "Suggestion for recovery"
        }
      }
    },
    "EdgeCase": {
      "type": "object",
      "description": "Edge case definition (Section 9 - Coverage)",
      "required": ["case", "expected"],
      "additionalProperties": false,
      "properties": {
        "case": {
          "type": "string",
          "minLength": 1,
          "description": "Edge case name/description"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of this edge case"
        },
        "input": {
          "description": "Example input that triggers this case"
        },
        "input_example": {
          "description": "Example input that triggers this case (legacy field name)"
        },
        "expected": {
          "type": "object",
          "description": "Expected behavior for this case"
        },
        "covers_rule": {
          "type": "string",
          "description": "Which decision_rule this case tests"
        },
        "covers_failure": {
          "type": "string",
          "description": "Which failure_mode this case tests"
        }
      }
    },
    "ContextInfo": {
      "type": "object",
      "description": "Context and collaboration info (Section 10 - optional)",
      "additionalProperties": false,
      "properties": {
        "works_with": {
          "type": "array",
          "description": "Related skills that work well together",
          "items": {
            "type": "object",
            "required": ["skill", "reason"],
            "properties": {
              "skill": {"type": "string"},
              "reason": {"type": "string"}
            }
          }
        },
        "prerequisites": {
          "type": "array",
          "description": "What user needs to do before using this skill",
          "items": {"type": "string"}
        },
        "scenarios": {
          "type": "array",
          "description": "Typical usage scenarios",
          "items": {
            "type": "object",
            "required": ["name", "description"],
            "properties": {
              "name": {"type": "string"},
              "trigger": {
                "type": "string",
                "description": "v1.1: What triggers this scenario"
              },
              "description": {"type": "string"}
            }
          }
        }
      }
    },
    "Example": {
      "type": "object",
      "description": "Usage example (for Anthropic format)",
      "required": ["name", "input", "output"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Example name"
        },
        "scenario": {
          "type": "string",
          "description": "v1.1: Context/scenario description"
        },
        "trigger": {
          "type": "string",
          "description": "v1.1: How user triggers this"
        },
        "input": {
          "description": "Example input values"
        },
        "output": {
          "description": "Expected output"
        },
        "explanation": {
          "type": "string",
          "description": "Explanation of what happens"
        }
      }
    }
  }
}
